{% extends 'base.html' %}
{% block content %}

<section class="cards" id="summary-cards"></section>

<h2>Latest Alerts</h2>
<table class="table" id="latest-alerts">
  <thead>
    <tr><th>Time</th><th>Host</th><th>Severity</th><th>Source</th><th>Message</th></tr>
  </thead>
  <tbody>
    <tr data-placeholder="1"><td colspan="5">Loading…</td></tr>
  </tbody>
</table>


<script>
/* ========== TOAST (self-contained, Overview-only) ========== */
/* 1) Ensure a top-right container exists */
(function ensureToastRoot(){
  if (!document.getElementById('toast-root')) {
    const root = document.createElement('div');
    root.id = 'toast-root';
    root.className = 'toast-wrap';
    document.body.appendChild(root);
  }
})();

/* 2) Minimal styles injected at runtime (avoids CSS file cache issues) */
(function injectToastCSS(){
  if (document.getElementById('toast-css')) return;
  const css = `
    .toast-wrap{
      position:fixed; top:16px; right:16px;
      z-index:4000; display:flex; flex-direction:column; gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      min-width:320px; max-width:520px;
      background:rgba(17,28,43,.98);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      color:#e7f1ff; padding:12px 14px; font-size:14px; line-height:1.3;
      display:flex; gap:10px; align-items:flex-start;
      animation:toastIn .22s ease-out both;
    }
    .toast .sev{ text-transform:uppercase; font-weight:700; letter-spacing:.02em;
      font-size:11px; padding:2px 6px; border-radius:6px; background:#243246; color:#cfe4ff; }
    .toast .sev.warning{ background:#483b1d; color:#ffd479; }
    .toast .sev.critical{ background:#4b1e22; color:#ff9aa2; }
    .toast .close{ margin-left:auto; opacity:.65; cursor:pointer; user-select:none; }
    @keyframes toastIn{ from{transform:translateY(-6px);opacity:0} to{transform:none;opacity:1} }
  `;
  const style = document.createElement('style');
  style.id = 'toast-css';
  style.textContent = css;
  document.head.appendChild(style);
})();

/* 3) Local toast function used by this page */
function showToast(message, {severity='info', source='', timeout=6000} = {}){
  const root = document.getElementById('toast-root');
  if (!root) return;
  const box = document.createElement('div');
  box.className = 'toast';
  box.innerHTML = `
    <span class="sev ${severity.toLowerCase()}">${severity}</span>
    <div>${source ? `<strong>${source}</strong> — ` : ''}${message}</div>
    <span class="close" title="Dismiss">✕</span>
  `;
  box.querySelector('.close').onclick = () => root.removeChild(box);
  root.prepend(box);
  if (timeout > 0) setTimeout(() => { try{ root.removeChild(box);}catch{} }, timeout);
}

/* ========== EXISTING OVERVIEW LOGIC (unchanged, but calls showToast) ========== */
(async function init() {
  const cardsEl = document.getElementById('summary-cards');
  const tbody   = document.querySelector('#latest-alerts tbody');
  const MAX_ROWS = 200;

  function hostBadges(data){
    const names = (data.hosts_inline || []).map(h =>
      `<a class="chip" href="/hosts/${encodeURIComponent(h)}" target="_blank">${h}</a>`).join(' ');
    const extra = (data.hosts_extra || 0) > 0 ? `<span class="chip muted">+${data.hosts_extra} more</span>` : '';
    return names + (extra ? ` ${extra}` : '');
  }

  function renderCards(s) {
    if (!s) return;
    const k8sUnhealthy = Number(s.k8s_pods_unhealthy ?? 0);
    const k8sApiDown   = Number(s.k8s_clusters_api_down ?? 0);
    const k8sHref = `/k8s?only_unhealthy=1&since_minutes=60`;


    const cpuNow = Number(s.cpu_now || 0).toFixed(1);
    const cpu1h  = Number(s.cpu_1h_avg || 0).toFixed(1);
    const memNow = Number(s.mem_now || 0).toFixed(1);
    const mem1h  = Number(s.mem_1h_avg || 0).toFixed(1);
    const loadNow= Number(s.load_now || 0).toFixed(2);
    const load1h = Number(s.load_1h_avg || 0).toFixed(2);
    const cpuTop = s.cpu_top && s.cpu_top.host ?
      `<a href="/hosts/${encodeURIComponent(s.cpu_top.host)}" target="_blank">${s.cpu_top.host}</a> ${Number(s.cpu_top.value).toFixed(1)}%` : '—';
    const memTop = s.mem_top && s.mem_top.host ?
      `<a href="/hosts/${encodeURIComponent(s.mem_top.host)}" target="_blank">${s.mem_top.host}</a> ${Number(s.mem_top.value).toFixed(1)}%` : '—';
    const loadTop = s.load_top && s.load_top.host ?
      `<a href="/hosts/${encodeURIComponent(s.load_top.host)}" target="_blank">${s.load_top.host}</a> ${Number(s.load_top.value).toFixed(2)}` : '—';
    cardsEl.innerHTML = `
      <div class="card">
        <div class="metric">${s.hosts_active_10m}</div>
        <div class="label">Active hosts (10m)</div>
        <div class="subline">${hostBadges(s)}</div>
      </div>
      <div class="card" style="cursor:pointer" onclick="location.href='${k8sHref}'">
        <div class="metric">${k8sUnhealthy}</div>
        <div class="label">Kubernetes <span class="sub">· unhealthy pods</span></div>
        <div class="subline">API down: ${k8sApiDown} <span class="sub">·</span> <a href="${k8sHref}" style="text-decoration:underline;">Open</a></div>
      </div>
      <div class="card">
        <div class="metric">${cpuNow}%</div>
        <div class="label">CPU now <span class="sub">· 1h avg ${cpu1h}%</span></div>
        <div class="subline">Top: ${cpuTop}</div>
      </div>
      <div class="card">
        <div class="metric">${memNow}%</div>
        <div class="label">Memory now <span class="sub">· 1h avg ${mem1h}%</span></div>
        <div class="subline">Top: ${memTop}</div>
      </div>
      <div class="card">
        <div class="metric">${loadNow}</div>
        <div class="label">Load now <span class="sub">· 1h avg ${load1h}</span></div>
        <div class="subline">Top: ${loadTop}</div>
      </div>`;
  }

  function renderInitialRows(list) {
    const rows = (list || []).map(a => `
      <tr>
        <td>${a.timestamp}</td>
        <td>${a.hostname || ''}</td>
        <td class="sev ${a.severity}">${a.severity}</td>
        <td>${a.source}</td>
        <td>${a.message}</td>
      </tr>`).join('');
    tbody.innerHTML = rows || `<tr data-placeholder="1"><td colspan="5">No recent alerts</td></tr>`;
  }

  async function fetchSummary() {
    try {
      const res = await fetch('/api/summary', { headers: { 'Accept': 'application/json' }});
      if (!res.ok) return;
      const data = await res.json();
      renderCards(data);
      if (tbody.children.length === 1 && tbody.firstElementChild.dataset.placeholder === "1") {
        renderInitialRows(data.latest_alerts);
      }
    } catch {}
  }

  await fetchSummary();
  setInterval(fetchSummary, 60000);

  let es, backoff = 1000, backMax = 15000, closed = false, refreshTimer = null;
  function scheduleSummaryRefresh() {
    if (refreshTimer) return;
    refreshTimer = setTimeout(async () => { refreshTimer = null; await fetchSummary(); }, 5000);
  }

  function connect() {
    try {
      es = new EventSource('/api/stream/alerts');

      es.addEventListener('alert', ev => {
        backoff = 1000;
        const a = JSON.parse(ev.data);

        // seed table if needed
        if (tbody.firstElementChild && tbody.firstElementChild.dataset.placeholder === "1") {
          tbody.removeChild(tbody.firstElementChild);
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.timestamp}</td>
          <td>${a.hostname || ''}</td>
          <td class="sev ${a.severity}">${a.severity}</td>
          <td>${a.source}</td>
          <td>${a.message}</td>`;
        tbody.prepend(tr);
        while (tbody.rows.length > 200) tbody.deleteRow(-1);

        // ← use local banner
        showToast(`${(a.severity || 'info').toUpperCase()}: ${a.message}`, {
          severity: a.severity || 'info',
          source: a.source || ''
        });

        scheduleSummaryRefresh();
      });

      es.onerror = () => {
        if (closed) return;
        try { es.close(); } catch {}
        setTimeout(connect, backoff);
        backoff = Math.min(backoff * 2, backMax);
      };
    } catch {
      setTimeout(connect, backoff);
    }
  }

  connect();
  window.addEventListener('beforeunload', () => { closed = true; if (es) es.close(); });
})();
</script>

{% endblock %}



